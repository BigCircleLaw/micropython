#include "freertos/FreeRTOS.h"
#include "oled.h"
// #include "../../../extmod/font_petme128_8x8.h"
#include "startup.h"

static const uint8_t font_petme128_8x8[];
static uint8_t oled_vram[OLED_WIDTH*OLED_HEIGHT/8];

esp_err_t write_cmd(uint8_t cmd) {
    uint8_t temp[2];
    temp[0] = 0x80;         // Co=1, D/C#=0
    temp[1] = cmd;
    return i2c_writeto(SH1106_I2C_ADDRESS, temp, sizeof(temp));
}

esp_err_t write_data(uint8_t * buff, size_t size) {
    if (size == 0) {
        return ESP_OK;
    }

    uint8_t temp[2];
    temp[0] = SH1106_I2C_ADDRESS << 1;
    temp[1] = 0x40;     // Co=0, D/C#=1
    i2c_cmd_handle_t handler = i2c_cmd_link_create();
    i2c_master_start(handler);
    i2c_master_write(handler, temp, sizeof(temp), ACK_CHECK_EN);
    i2c_master_write(handler, buff, size, ACK_CHECK_EN);
    i2c_master_stop(handler);
    esp_err_t ret = i2c_master_cmd_begin(I2C_MASTER_NUM, handler, 500/portTICK_RATE_MS);
    i2c_cmd_link_delete(handler);
    return ret;
}

const uint8_t oled_init_cmd[] = {
    SET_DISP_OFF,               // display off
	SET_DISP_CLK_DIV, 0x80,     // timing and driving scheme
	SET_MUX_RATIO, 0x3f,        // 0xa8
	SET_DISP_OFFSET, 0x00,      // 0xd3
	SET_DISP_START_LINE | 0x00, // start line
	SET_CHARGE_PUMP,  0x10,     // 0x10 if external_vcc else 0x14,
	SET_MEM_ADDR, 0x00,         // address setting
	SET_SEG_REMAP | 0x01,       // column addr 127 mapped to SEG0
	SET_COM_OUT_DIR | 0x08,     // scan from COM[N] to COM0
	SET_COM_PIN_CFG, 0x12,
	SET_CONTRACT_CTRL, 0xcf,
	SET_PRECHARGE, 0x22,        // 0x22 if self.external_vcc else 0xf1,
	SET_VCOM_DESEL, 0x40,       // 0.83*Vcc
	SET_ENTIRE_ON,              // output follows RAM contents
	SET_NORM_INV,       
	SET_DISP_ON                 // on
};

bool oled_init() {
    i2c_master_init();
    for (int i = 0; i < sizeof(oled_init_cmd); i++) {
        if (write_cmd(oled_init_cmd[i]) != ESP_OK) {
            return false;
        }
    }
    return true;
}

void oled_deinit() 
{
    i2c_master_deinit();
}

void oled_drawPixel(int16_t x, int16_t y, int16_t color) {
  if ((x < 0) || (x >= OLED_WIDTH) || (y < 0) || (y >= OLED_HEIGHT))
    return;
    // x is which column
    switch (color) 
    {
      case WHITE:   oled_vram[x+ (y/8)*OLED_WIDTH] |=  (1 << (y&7)); break;
      case BLACK:   oled_vram[x+ (y/8)*OLED_WIDTH] &= ~(1 << (y&7)); break; 
      case INVERSE: oled_vram[x+ (y/8)*OLED_WIDTH] ^=  (1 << (y&7)); break; 
    }
}

void oled_clear()
{
    for (int i = 0; i < sizeof(oled_vram); i++) {
        oled_vram[i] = 0;
    }
}

void oled_drawImg(const uint8_t * img) 
{
    for (int i = 0; i < sizeof(oled_vram); i++) {
        oled_vram[i] = img[i];
    }
}
const uint8_t * ani_startup[25] = {
    img_00001, img_00002, img_00003, img_00004, img_00005,
    img_00006, img_00007, img_00008, img_00009, img_00010,
    img_00011, img_00012, img_00013, img_00014, img_00015,
    img_00016, img_00017, img_00018, img_00019, img_00020,
    img_00021, img_00022, img_00023, img_00024, img_00030,
};

void oled_drawAnimation(const uint8_t **pImgs, int len, int frameRate)
{
    int i = 0;
    for (; i < len; i++) {
        oled_drawImg(pImgs[i]);
        oled_show();
        vTaskDelay(1000/frameRate /portTICK_RATE_MS);
    } 
    // for (i = len -1; i >= 0; i--) {
    //     oled_drawImg(pImgs[i]);
    //     oled_show();
    //     vTaskDelay(1000/frameRate /portTICK_RATE_MS);
    // } 
}

void oled_print(const char * str, int x0, int y0)
{
    while(*str) {
        char c = *str++;
        if ( c < 32 || c > 127) {
            if (c == '\n') {
                y0 += 8;
                x0 = 0;
                continue;
            } else {
                c = 32;
            }
        }
        // auto new line,when reach the right sidle
        if (x0 >= OLED_WIDTH) {
            y0 += 8;
            x0 = 0;
        }
        // get char data
        const uint8_t *chr_data = &font_petme128_8x8[(c - 32) * 8];
        // loop over char data
        for (int j = 0; j < 8; j++, x0++) {
            if (0 <= x0 && x0 < OLED_WIDTH) { // clip x
                uint8_t vline_data = chr_data[j]; // each byte is a column of 8 pixels, LSB at top
                for (int y = y0; vline_data; vline_data >>= 1, y++) { // scan over vertical column
                    if (vline_data & 1) { // only draw if pixel set
                        if (0 <= y && y < OLED_HEIGHT) { // clip y
                            oled_drawPixel(x0, y, 1);
                        }
                    }
                }
            }
        }

    }
}

void oled_show() {
    for (uint8_t i = 0; i < OLED_HEIGHT/8; i++) {
        write_cmd(SET_PAGE_ADDR1 | i);
        write_cmd(SET_COL_ADDR_L | 0);
        write_cmd(SET_COL_ADDR_H | 0);
        write_data((oled_vram + i*OLED_WIDTH), OLED_WIDTH);
        //vTaskDelay(10 / portTICK_RATE_MS);
    }
}

static const uint8_t font_petme128_8x8[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // 32= 
    0x00,0x00,0x00,0x4f,0x4f,0x00,0x00,0x00, // 33=!
    0x00,0x07,0x07,0x00,0x00,0x07,0x07,0x00, // 34="
    0x14,0x7f,0x7f,0x14,0x14,0x7f,0x7f,0x14, // 35=#
    0x00,0x24,0x2e,0x6b,0x6b,0x3a,0x12,0x00, // 36=$
    0x00,0x63,0x33,0x18,0x0c,0x66,0x63,0x00, // 37=%
    0x00,0x32,0x7f,0x4d,0x4d,0x77,0x72,0x50, // 38=&
    0x00,0x00,0x00,0x04,0x06,0x03,0x01,0x00, // 39='
    0x00,0x00,0x1c,0x3e,0x63,0x41,0x00,0x00, // 40=(
    0x00,0x00,0x41,0x63,0x3e,0x1c,0x00,0x00, // 41=)
    0x08,0x2a,0x3e,0x1c,0x1c,0x3e,0x2a,0x08, // 42=*
    0x00,0x08,0x08,0x3e,0x3e,0x08,0x08,0x00, // 43=+
    0x00,0x00,0x80,0xe0,0x60,0x00,0x00,0x00, // 44=,
    0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00, // 45=-
    0x00,0x00,0x00,0x60,0x60,0x00,0x00,0x00, // 46=.
    0x00,0x40,0x60,0x30,0x18,0x0c,0x06,0x02, // 47=/
    0x00,0x3e,0x7f,0x49,0x45,0x7f,0x3e,0x00, // 48=0
    0x00,0x40,0x44,0x7f,0x7f,0x40,0x40,0x00, // 49=1
    0x00,0x62,0x73,0x51,0x49,0x4f,0x46,0x00, // 50=2
    0x00,0x22,0x63,0x49,0x49,0x7f,0x36,0x00, // 51=3
    0x00,0x18,0x18,0x14,0x16,0x7f,0x7f,0x10, // 52=4
    0x00,0x27,0x67,0x45,0x45,0x7d,0x39,0x00, // 53=5
    0x00,0x3e,0x7f,0x49,0x49,0x7b,0x32,0x00, // 54=6
    0x00,0x03,0x03,0x79,0x7d,0x07,0x03,0x00, // 55=7
    0x00,0x36,0x7f,0x49,0x49,0x7f,0x36,0x00, // 56=8
    0x00,0x26,0x6f,0x49,0x49,0x7f,0x3e,0x00, // 57=9
    0x00,0x00,0x00,0x24,0x24,0x00,0x00,0x00, // 58=:
    0x00,0x00,0x80,0xe4,0x64,0x00,0x00,0x00, // 59=;
    0x00,0x08,0x1c,0x36,0x63,0x41,0x41,0x00, // 60=<
    0x00,0x14,0x14,0x14,0x14,0x14,0x14,0x00, // 61==
    0x00,0x41,0x41,0x63,0x36,0x1c,0x08,0x00, // 62=>
    0x00,0x02,0x03,0x51,0x59,0x0f,0x06,0x00, // 63=?
    0x00,0x3e,0x7f,0x41,0x4d,0x4f,0x2e,0x00, // 64=@
    0x00,0x7c,0x7e,0x0b,0x0b,0x7e,0x7c,0x00, // 65=A
    0x00,0x7f,0x7f,0x49,0x49,0x7f,0x36,0x00, // 66=B
    0x00,0x3e,0x7f,0x41,0x41,0x63,0x22,0x00, // 67=C
    0x00,0x7f,0x7f,0x41,0x63,0x3e,0x1c,0x00, // 68=D
    0x00,0x7f,0x7f,0x49,0x49,0x41,0x41,0x00, // 69=E
    0x00,0x7f,0x7f,0x09,0x09,0x01,0x01,0x00, // 70=F
    0x00,0x3e,0x7f,0x41,0x49,0x7b,0x3a,0x00, // 71=G
    0x00,0x7f,0x7f,0x08,0x08,0x7f,0x7f,0x00, // 72=H
    0x00,0x00,0x41,0x7f,0x7f,0x41,0x00,0x00, // 73=I
    0x00,0x20,0x60,0x41,0x7f,0x3f,0x01,0x00, // 74=J
    0x00,0x7f,0x7f,0x1c,0x36,0x63,0x41,0x00, // 75=K
    0x00,0x7f,0x7f,0x40,0x40,0x40,0x40,0x00, // 76=L
    0x00,0x7f,0x7f,0x06,0x0c,0x06,0x7f,0x7f, // 77=M
    0x00,0x7f,0x7f,0x0e,0x1c,0x7f,0x7f,0x00, // 78=N
    0x00,0x3e,0x7f,0x41,0x41,0x7f,0x3e,0x00, // 79=O
    0x00,0x7f,0x7f,0x09,0x09,0x0f,0x06,0x00, // 80=P
    0x00,0x1e,0x3f,0x21,0x61,0x7f,0x5e,0x00, // 81=Q
    0x00,0x7f,0x7f,0x19,0x39,0x6f,0x46,0x00, // 82=R
    0x00,0x26,0x6f,0x49,0x49,0x7b,0x32,0x00, // 83=S
    0x00,0x01,0x01,0x7f,0x7f,0x01,0x01,0x00, // 84=T
    0x00,0x3f,0x7f,0x40,0x40,0x7f,0x3f,0x00, // 85=U
    0x00,0x1f,0x3f,0x60,0x60,0x3f,0x1f,0x00, // 86=V
    0x00,0x7f,0x7f,0x30,0x18,0x30,0x7f,0x7f, // 87=W
    0x00,0x63,0x77,0x1c,0x1c,0x77,0x63,0x00, // 88=X
    0x00,0x07,0x0f,0x78,0x78,0x0f,0x07,0x00, // 89=Y
    0x00,0x61,0x71,0x59,0x4d,0x47,0x43,0x00, // 90=Z
    0x00,0x00,0x7f,0x7f,0x41,0x41,0x00,0x00, // 91=[
    0x00,0x02,0x06,0x0c,0x18,0x30,0x60,0x40, // 92='\'
    0x00,0x00,0x41,0x41,0x7f,0x7f,0x00,0x00, // 93=]
    0x00,0x08,0x0c,0x06,0x06,0x0c,0x08,0x00, // 94=^
    0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0, // 95=_
    0x00,0x00,0x01,0x03,0x06,0x04,0x00,0x00, // 96=`
    0x00,0x20,0x74,0x54,0x54,0x7c,0x78,0x00, // 97=a
    0x00,0x7f,0x7f,0x44,0x44,0x7c,0x38,0x00, // 98=b
    0x00,0x38,0x7c,0x44,0x44,0x6c,0x28,0x00, // 99=c
    0x00,0x38,0x7c,0x44,0x44,0x7f,0x7f,0x00, // 100=d
    0x00,0x38,0x7c,0x54,0x54,0x5c,0x58,0x00, // 101=e
    0x00,0x08,0x7e,0x7f,0x09,0x03,0x02,0x00, // 102=f
    0x00,0x98,0xbc,0xa4,0xa4,0xfc,0x7c,0x00, // 103=g
    0x00,0x7f,0x7f,0x04,0x04,0x7c,0x78,0x00, // 104=h
    0x00,0x00,0x00,0x7d,0x7d,0x00,0x00,0x00, // 105=i
    0x00,0x40,0xc0,0x80,0x80,0xfd,0x7d,0x00, // 106=j
    0x00,0x7f,0x7f,0x30,0x38,0x6c,0x44,0x00, // 107=k
    0x00,0x00,0x41,0x7f,0x7f,0x40,0x00,0x00, // 108=l
    0x00,0x7c,0x7c,0x18,0x30,0x18,0x7c,0x7c, // 109=m
    0x00,0x7c,0x7c,0x04,0x04,0x7c,0x78,0x00, // 110=n
    0x00,0x38,0x7c,0x44,0x44,0x7c,0x38,0x00, // 111=o
    0x00,0xfc,0xfc,0x24,0x24,0x3c,0x18,0x00, // 112=p
    0x00,0x18,0x3c,0x24,0x24,0xfc,0xfc,0x00, // 113=q
    0x00,0x7c,0x7c,0x04,0x04,0x0c,0x08,0x00, // 114=r
    0x00,0x48,0x5c,0x54,0x54,0x74,0x20,0x00, // 115=s
    0x04,0x04,0x3f,0x7f,0x44,0x64,0x20,0x00, // 116=t
    0x00,0x3c,0x7c,0x40,0x40,0x7c,0x3c,0x00, // 117=u
    0x00,0x1c,0x3c,0x60,0x60,0x3c,0x1c,0x00, // 118=v
    0x00,0x1c,0x7c,0x30,0x18,0x30,0x7c,0x1c, // 119=w
    0x00,0x44,0x6c,0x38,0x38,0x6c,0x44,0x00, // 120=x
    0x00,0x9c,0xbc,0xa0,0xa0,0xfc,0x7c,0x00, // 121=y
    0x00,0x44,0x64,0x74,0x5c,0x4c,0x44,0x00, // 122=z
    0x00,0x08,0x08,0x3e,0x77,0x41,0x41,0x00, // 123={
    0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00, // 124=|
    0x00,0x41,0x41,0x77,0x3e,0x08,0x08,0x00, // 125=}
    0x00,0x02,0x03,0x01,0x03,0x02,0x03,0x01, // 126=~
    0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55, // 127
};
